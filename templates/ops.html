<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ¸¸æˆç»¼åˆè¿è¥å° v3.9 (AI Assistants)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .tab-btn.active {
            background-color: #4f46e5;
            color: white;
            border-bottom: 2px solid #312e81;
        }
        .tab-btn { transition: all 0.2s; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>
</head>
<body class="bg-gray-100 p-5 min-h-screen">

<div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-2"></div>

<div class="max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-extrabold text-indigo-700 flex items-center gap-3">
            <span class="text-4xl">ğŸ› ï¸</span>
            <div>
                æ¸¸æˆç»¼åˆè¿è¥å°
                <div class="text-xs text-gray-500 font-normal mt-1">v3.9 - AI Assistants</div>
            </div>
        </h1>
        <a href="/editor" target="_blank" class="bg-green-600 text-white px-4 py-2 rounded font-bold hover:bg-green-700 text-sm">æ‰“å¼€åœ°å›¾ç¼–è¾‘å™¨</a>
    </div>

    <div class="flex flex-wrap gap-2 mb-6 border-b-2 border-gray-200 pb-1">
        <button onclick="switchTab('users')" id="tab-btn-users" class="tab-btn active px-6 py-3 rounded-t-lg font-bold text-gray-600 hover:bg-indigo-50">ğŸ‘¥ ç”¨æˆ·</button>
        <button onclick="switchTab('gifts')" id="tab-btn-gifts" class="tab-btn px-6 py-3 rounded-t-lg font-bold text-gray-600 hover:bg-indigo-50">ğŸ ç¤¼ç‰©</button>
        <button onclick="switchTab('skins')" id="tab-btn-skins" class="tab-btn px-6 py-3 rounded-t-lg font-bold text-gray-600 hover:bg-indigo-50">ğŸ‘• çš®è‚¤</button>
        <button onclick="switchTab('codes')" id="tab-btn-codes" class="tab-btn px-6 py-3 rounded-t-lg font-bold text-gray-600 hover:bg-indigo-50">ğŸŸï¸ å…‘æ¢ç </button>
        <button onclick="switchTab('maps')" id="tab-btn-maps" class="tab-btn px-6 py-3 rounded-t-lg font-bold text-gray-600 hover:bg-indigo-50">ğŸ—ºï¸ åœ°å›¾æ± </button>
        <button onclick="switchTab('assistants')" id="tab-btn-assistants" class="tab-btn px-6 py-3 rounded-t-lg font-bold text-gray-600 hover:bg-indigo-50">ğŸ¤– AIåŠ©æ‰‹</button>
        <button onclick="switchTab('logs')" id="tab-btn-logs" class="tab-btn px-6 py-3 rounded-t-lg font-bold text-gray-600 hover:bg-indigo-50">ğŸ“ è®°å½•</button>
        <button onclick="switchTab('config')" id="tab-btn-config" class="tab-btn px-6 py-3 rounded-t-lg font-bold text-gray-600 hover:bg-indigo-50">âš™ï¸ å‚æ•°</button>
    </div>

    <!-- 1. ç”¨æˆ· -->
    <div id="section-users" class="tab-section bg-white p-6 rounded-b-lg rounded-tr-lg shadow-lg">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-gray-800 border-l-4 border-indigo-500 pl-3">ç©å®¶åˆ—è¡¨</h2>
            <div class="flex gap-2"><input type="text" id="searchUserInput" placeholder="æœç”¨æˆ·å..." class="border p-2 rounded w-64 text-sm"><button onclick="loadUsers()" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm shadow">æœç´¢</button></div>
        </div>
        <div class="overflow-x-auto border rounded-lg"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="p-3 text-left">ç”¨æˆ·</th><th class="p-3">é‡‘å¸</th><th class="p-3">ç§¯åˆ†</th><th class="p-3">çš®è‚¤</th><th class="p-3">æ“ä½œ</th></tr></thead><tbody id="userTableBody"></tbody></table></div>
    </div>

    <!-- 2. ç¤¼ç‰© -->
    <div id="section-gifts" class="tab-section hidden bg-white p-6 rounded-b-lg rounded-tr-lg shadow-lg">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 bg-blue-50 p-5 rounded-xl border border-blue-100 h-fit"><h3 class="font-bold text-blue-800 mb-4">â• ä¸Šæ¶</h3><form id="addGiftForm" class="flex flex-col gap-4"><div><label class="text-xs font-bold text-gray-500">åç§°</label><input name="name" required class="w-full border p-2 rounded"></div><div class="grid grid-cols-2 gap-2"><div><label class="text-xs font-bold text-gray-500">ç§¯åˆ†</label><input type="number" name="price" required class="w-full border p-2 rounded"></div><div><label class="text-xs font-bold text-gray-500">åº“å­˜</label><input type="number" name="stock" required class="w-full border p-2 rounded"></div></div><div><label class="text-xs font-bold text-gray-500">å›¾ç‰‡</label><input type="file" name="image" class="w-full text-xs"></div><button class="bg-blue-600 text-white py-2 rounded font-bold mt-2">ä¸Šæ¶</button></form></div>
            <div class="lg:col-span-2"><div class="flex justify-between mb-4"><h3 class="text-xl font-bold pl-3 border-l-4 border-indigo-500">åˆ—è¡¨</h3><button onclick="loadGifts()" class="text-indigo-600 text-sm">åˆ·æ–°</button></div><div class="overflow-x-auto border rounded-lg h-[600px]"><table class="min-w-full divide-y divide-gray-200 relative"><tbody id="giftTableBody"></tbody></table></div></div>
        </div>
    </div>

    <!-- 3. çš®è‚¤ -->
    <div id="section-skins" class="tab-section hidden bg-white p-6 rounded-b-lg rounded-tr-lg shadow-lg">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 bg-purple-50 p-5 rounded-xl border border-purple-100 h-fit"><h3 class="font-bold text-purple-800 mb-4">ğŸ‘• ä¸Šä¼ </h3><form id="addSkinForm" class="flex flex-col gap-4"><input name="name" placeholder="åç§°" required class="border p-2 rounded"><input type="file" name="image" required class="text-sm"><button class="bg-purple-600 text-white py-2 rounded font-bold">ä¸Šä¼ </button></form></div>
            <div class="lg:col-span-2"><div class="flex justify-between mb-4"><h3 class="text-xl font-bold pl-3 border-l-4 border-indigo-500">åº“</h3><button onclick="loadSkins()" class="text-indigo-600">åˆ·æ–°</button></div><div id="skinGrid" class="grid grid-cols-4 gap-4"></div></div>
        </div>
    </div>

    <!-- 4. å…‘æ¢ç  -->
    <div id="section-codes" class="tab-section hidden bg-white p-6 rounded-b-lg rounded-tr-lg shadow-lg">
        <div class="bg-green-50 p-4 rounded mb-6 flex gap-4 items-end"><div class="flex-1"><label class="text-xs font-bold text-green-800">ä»£ç </label><input id="newCodeStr" class="w-full border p-2 rounded"></div><div class="w-24"><label class="text-xs font-bold text-green-800">é‡‘å¸</label><input type="number" id="newCodeReward" value="100" class="w-full border p-2 rounded"></div><div class="w-24"><label class="text-xs font-bold text-green-800">æ¬¡æ•°</label><input type="number" id="newCodeMax" value="1" class="w-full border p-2 rounded"></div><button onclick="createCode()" class="bg-green-600 text-white px-6 py-2 rounded font-bold h-[42px]">ç”Ÿæˆ</button></div>
        <div class="overflow-x-auto border rounded-lg"><table class="min-w-full divide-y divide-gray-200"><tbody id="codeTableBody"></tbody></table></div>
    </div>

    <!-- 5. åœ°å›¾ç®¡ç† -->
    <div id="section-maps" class="tab-section hidden bg-white p-6 rounded-b-lg rounded-tr-lg shadow-lg">
        <div class="flex justify-between mb-6">
            <h2 class="text-xl font-bold pl-3 border-l-4 border-indigo-500">åœ°å›¾æ¦‚ç‡é…ç½®</h2>
            <button onclick="loadMaps()" class="bg-indigo-50 text-indigo-600 px-4 py-2 rounded font-bold text-sm">åˆ·æ–°åˆ—è¡¨</button>
        </div>
        <div class="mb-4 text-sm text-gray-500 bg-gray-50 p-2 rounded flex justify-between">
            <span>æç¤ºï¼šæƒé‡è¶Šé«˜ï¼Œè¯¥åœ°å›¾è¢«éšæœºé€‰ä¸­çš„æ¦‚ç‡è¶Šå¤§ã€‚ç³»ç»Ÿé»˜è®¤åœ°å›¾ä¸å¯åˆ é™¤ã€‚</span>
            <span class="flex gap-4"><span class="flex items-center gap-1"><span class="w-3 h-3 bg-blue-100 border border-blue-500 block"></span> å®˜æ–¹</span> <span class="flex items-center gap-1"><span class="w-3 h-3 bg-green-100 border border-green-500 block"></span> ç©å®¶è‡ªåˆ¶</span></span>
        </div>
        <div id="mapsGrid" class="grid grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>

    <!-- 6. AI Assistants Section -->
    <div id="section-assistants" class="tab-section hidden bg-white p-6 rounded-b-lg rounded-tr-lg shadow-lg">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 bg-indigo-50 p-5 rounded-xl border border-indigo-100 h-fit">
                <h3 id="assistant-form-title" class="font-bold text-indigo-800 mb-4">â• æ–°å»ºAIåŠ©æ‰‹</h3>
                <form id="assistantForm" class="flex flex-col gap-4">
                    <input type="hidden" id="asst-id">
                    <div><label class="text-xs font-bold text-gray-500">åŠ©æ‰‹åç§°</label><input id="asst-name" required class="w-full border p-2 rounded"></div>
                    <div><label class="text-xs font-bold text-gray-500">OpenAI API Key</label><input id="asst-key" type="password" class="w-full border p-2 rounded"></div>
                    <div><label class="text-xs font-bold text-gray-500">æ¨¡å‹ (Model)</label><input id="asst-model" placeholder="e.g., gpt-4, gemini-pro" class="w-full border p-2 rounded"></div>
                    <div><label class="text-xs font-bold text-gray-500">ç³»ç»Ÿæç¤ºè¯ (System Prompt)</label><textarea id="asst-prompt" rows="6" class="w-full border p-2 rounded"></textarea></div>
                    <div class="flex items-center gap-2"><input id="asst-active" type="checkbox" checked><label for="asst-active" class="text-sm font-bold">å¯ç”¨</label></div>
                    <div class="flex gap-2">
                        <button type="submit" class="flex-1 bg-indigo-600 text-white py-2 rounded font-bold">ä¿å­˜</button>
                        <button type="button" onclick="resetAssistantForm()" class="bg-gray-300 px-4 rounded">å–æ¶ˆ</button>
                    </div>
                </form>
            </div>
            <div class="lg:col-span-2">
                <div class="flex justify-between mb-4"><h3 class="text-xl font-bold pl-3 border-l-4 border-indigo-500">åŠ©æ‰‹åˆ—è¡¨</h3><button onclick="loadAssistants()" class="text-indigo-600 text-sm">åˆ·æ–°</button></div>
                <div id="assistants-list" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <!-- 7. æ—¥å¿— -->
    <div id="section-logs" class="tab-section hidden bg-white p-6 rounded-b-lg rounded-tr-lg shadow-lg">
        <div class="flex justify-between mb-4"><h2 class="text-xl font-bold pl-3 border-l-4 border-indigo-500">æ—¥å¿—</h2><button onclick="loadRedemptions()" class="bg-gray-100 border px-3 py-1 rounded text-sm">åˆ·æ–°</button></div>
        <div class="overflow-x-auto border rounded-lg h-[600px]"><table class="min-w-full divide-y divide-gray-200"><tbody id="logTableBody"></tbody></table></div>
    </div>

    <!-- 8. æ¸¸æˆé…ç½® -->
    <div id="section-config" class="tab-section hidden bg-white p-6 rounded-b-lg rounded-tr-lg shadow-lg">
        <form id="gameConfigForm" class="space-y-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-l-4 border-indigo-500 pl-3">æ ¸å¿ƒè§„åˆ™é…ç½®</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gray-50 p-5 rounded-lg border"><label class="block font-bold mb-2 text-gray-700">ğŸ•³ï¸ åº•æ´æ•°é‡</label><input type="number" id="cfg_slot_count" class="w-full border p-2 rounded"></div>
                <div class="bg-red-50 p-5 rounded-lg border border-red-200"><label class="block font-bold mb-2 text-red-800">ğŸ’£ ç‚¸å¼¹å¹²æ‰°</label><div class="grid grid-cols-3 gap-2 text-sm"><div>æ¦‚ç‡ <input id="cfg_bomb_prob" class="w-full border p-1" type="number" step="0.1"></div><div>Min <input id="cfg_bomb_min" class="w-full border p-1" type="number"></div><div>Max <input id="cfg_bomb_max" class="w-full border p-1" type="number"></div></div></div>
                <div class="bg-yellow-50 p-5 rounded-lg border border-yellow-200"><label class="block font-bold mb-2 text-yellow-800">ğŸŸ¡ é‡‘å¸å¹²æ‰°çƒ</label><div class="grid grid-cols-2 gap-4"><div><span class="text-xs font-bold">ä¸´æ—¶çƒ</span><div class="grid grid-cols-4 gap-2 text-xs mt-1"><input id="cfg_temp_prob" placeholder="æ¦‚ç‡" class="border p-1"><input id="cfg_temp_min" placeholder="Min" class="border p-1"><input id="cfg_temp_max" placeholder="Max" class="border p-1"><input id="cfg_temp_val" placeholder="Value" class="border p-1"></div></div><div><span class="text-xs font-bold">å›ºå®šçƒ</span><div class="grid grid-cols-4 gap-2 text-xs mt-1"><input id="cfg_fixed_prob" placeholder="æ¦‚ç‡" class="border p-1"><input id="cfg_fixed_min" placeholder="Min" class="border p-1"><input id="cfg_fixed_max" placeholder="Max" class="border p-1"><input id="cfg_fixed_val" placeholder="Value" class="border p-1"></div></div></div></div>
                <div class="bg-orange-50 p-5 rounded-lg border border-orange-200"><label class="block font-bold mb-2 text-orange-800">ğŸ¥š é‡‘è›‹é…ç½®</label><div class="mb-2 flex gap-4"><div><span class="text-sm font-bold">å‡ºç°æ¦‚ç‡:</span> <input id="cfg_egg_appear_prob" type="number" step="0.01" class="border w-20 p-1 text-sm"></div><div><span class="text-sm font-bold">æ•°é‡Min:</span> <input id="cfg_egg_count_min" type="number" class="border w-16 p-1 text-sm"></div><div><span class="text-sm font-bold">æ•°é‡Max:</span> <input id="cfg_egg_count_max" type="number" class="border w-16 p-1 text-sm"></div></div><div class="grid grid-cols-3 gap-2 text-xs bg-white p-2 rounded border"><div class="text-center font-bold text-gray-600">é‡‘å¸</div><div class="text-center font-bold text-gray-600">ç§¯åˆ†</div><div class="text-center font-bold text-gray-600">è€é¼ </div><div><span class="text-gray-400">æ¦‚ç‡</span><input id="cfg_egg_prob_coin" class="w-full border p-1 text-center" step="0.1"></div><div><span class="text-gray-400">æ¦‚ç‡</span><input id="cfg_egg_prob_ticket" class="w-full border p-1 text-center" step="0.1"></div><div><span class="text-gray-400">æ¦‚ç‡</span><input id="cfg_egg_prob_mouse" class="w-full border p-1 text-center" step="0.1"></div><div><span class="text-gray-400">å¥–åŠ±</span><input id="cfg_egg_reward_coin" class="w-full border p-1 text-center"></div><div><span class="text-gray-400">å¥–åŠ±</span><input id="cfg_egg_reward_ticket" class="w-full border p-1 text-center"></div><div><span class="text-gray-400">æŸå¤±(é‡‘å¸)</span><input id="cfg_egg_penalty_coin" class="w-full border p-1 text-center"></div><div></div><div></div><div><span class="text-gray-400">æŸå¤±(ç§¯åˆ†)</span><input id="cfg_egg_penalty_ticket" class="w-full border p-1 text-center"></div></div></div>
                <div class="bg-gray-50 p-5 rounded-lg border"><label class="block font-bold mb-2 text-gray-700">ğŸ’¡ äº®ç¯æ¦‚ç‡ (%)</label><div class="grid grid-cols-5 gap-2 text-sm"><div>1<input id="cfg_light_1" class="w-full border p-1" type="number"></div><div>2<input id="cfg_light_2" class="w-full border p-1" type="number"></div><div>3<input id="cfg_light_3" class="w-full border p-1" type="number"></div><div>4<input id="cfg_light_4" class="w-full border p-1" type="number"></div><div>5<input id="cfg_light_5" class="w-full border p-1" type="number"></div></div></div>
                <div class="bg-gray-50 p-5 rounded-lg border"><label class="block font-bold mb-2 text-gray-700">âœ–ï¸ å€ç‡</label><div class="grid grid-cols-5 gap-2 text-sm"><div>1<input id="cfg_mult_1" class="w-full border p-1" type="number"></div><div>2<input id="cfg_mult_2" class="w-full border p-1" type="number"></div><div>3<input id="cfg_mult_3" class="w-full border p-1" type="number"></div><div>4<input id="cfg_mult_4" class="w-full border p-1" type="number"></div><div>5<input id="cfg_mult_5" class="w-full border p-1" type="number"></div></div></div>
                <div class="bg-purple-50 p-5 rounded-lg border border-purple-200 col-span-2"><label class="block font-bold mb-2 text-purple-800 flex gap-2"><input type="checkbox" id="cfg_wheel_enabled"> ğŸŒŸ å¹¸è¿è½¬ç›˜</label><div class="flex gap-4 text-sm"><span>æ¦‚ç‡: <input id="cfg_wheel_prob" type="number" step="0.1" class="border w-16 p-1"></span><span>Min: <input id="cfg_wheel_min" type="number" class="border w-20 p-1"></span><span>Max: <input id="cfg_wheel_max" type="number" class="border w-20 p-1"></span></div></div>
                <div class="bg-blue-50 p-5 rounded-lg border border-blue-200 col-span-2"><label class="block font-bold mb-2 text-blue-800">ğŸ’± ç§¯åˆ†å…‘æ¢è®¾ç½®</label><div class="flex items-center gap-2"><span class="text-sm">1 ç§¯åˆ† = </span><input id="cfg_exchange_rate" type="number" step="0.01" class="border w-24 p-1 rounded" placeholder="æ±‡ç‡"><span class="text-sm">é‡‘å¸</span><span class="text-xs text-gray-500 ml-2">(ä¾‹å¦‚: 0.1 è¡¨ç¤º 10 ç§¯åˆ†æ¢ 1 é‡‘å¸)</span></div></div>
            </div>
            <div class="mt-8 pt-6 border-t"><h2 class="text-xl font-bold text-gray-800 mb-4 border-l-4 border-teal-500 pl-3">ğŸ¤– å…¨å±€AI/TTSé…ç½® (é»˜è®¤)</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="bg-teal-50 p-5 rounded-lg border border-teal-200 space-y-4"><h3 class="font-bold text-teal-800">OpenAI å…¼å®¹æ¥å£</h3><label class="block font-bold text-gray-700 flex items-center gap-2"><input type="checkbox" id="cfg_ai_voice_enabled"> å¯ç”¨ AI è¯­éŸ³åŠŸèƒ½</label><div><label class="text-xs font-bold text-gray-500">API Endpoint</label><input id="cfg_openai_endpoint" class="w-full border p-2 rounded"></div><div><label class="text-xs font-bold text-gray-500">API Key</label><input id="cfg_openai_key" type="password" class="w-full border p-2 rounded"></div><div><label class="text-xs font-bold text-gray-500">AI å›å¤æœ€å¤§å­—æ•° (å¤§è‡´)</label><input id="cfg_ai_max_tokens" type="number" class="w-full border p-2 rounded"></div></div><div class="bg-cyan-50 p-5 rounded-lg border border-cyan-200 space-y-4"><h3 class="font-bold text-cyan-800">TTS è¯­éŸ³åˆæˆ</h3><div><label class="text-xs font-bold text-gray-500">TTS æ¨¡å¼</label><select id="cfg_tts_mode" class="w-full border p-2 rounded"><option value="server">æœåŠ¡ç«¯åˆæˆ (æ¨è)</option><option value="client">å®¢æˆ·ç«¯åˆæˆ (æµè§ˆå™¨)</option></select></div><div><label class="text-xs font-bold text-gray-500">TTS API Endpoint (æœåŠ¡ç«¯æ¨¡å¼)</label><input id="cfg_tts_endpoint" class="w-full border p-2 rounded"></div><div><label class="text-xs font-bold text-gray-500">TTS éŸ³æºåç§° (æœåŠ¡ç«¯æ¨¡å¼)</label><input id="cfg_tts_voice" class="w-full border p-2 rounded"></div><div><label class="text-xs font-bold text-gray-500">TTS æ–‡ä»¶å­˜å‚¨ç›®å½• (æœåŠ¡ç«¯æ¨¡å¼)</label><input id="cfg_tts_local_path" class="w-full border p-2 rounded" placeholder="ä¾‹å¦‚ /path/to/tts/audio/files"></div></div></div></div>
            <div class="pt-4 border-t mt-4"><button type="submit" class="bg-indigo-600 text-white px-8 py-3 rounded-lg font-bold shadow-lg">ä¿å­˜å…¨éƒ¨é…ç½®</button></div>
        </form>
    </div>
</div>

<!-- MODALS -->
<div id="userModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center z-50"><div class="bg-white p-6 rounded-lg w-96 shadow-xl"><h3 class="font-bold mb-4">ç¼–è¾‘ç”¨æˆ·: <span id="editUserTitle" class="text-indigo-600"></span></h3><div class="space-y-3"><input id="editUserCoins" type="number" class="w-full border p-2" placeholder="é‡‘å¸"><input id="editUserTickets" type="number" class="w-full border p-2" placeholder="ç§¯åˆ†"></div><div class="flex justify-end gap-3 mt-4"><button onclick="closeModal('userModal')" class="px-4 py-2 text-gray-500">å–æ¶ˆ</button><button onclick="saveUserEdit()" class="bg-indigo-600 text-white px-4 py-2 rounded">ä¿å­˜</button></div></div></div>
<div id="giftModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center z-50"><div class="bg-white p-6 rounded-lg w-96 shadow-xl"><h3 class="font-bold mb-4">ç¼–è¾‘ç¤¼ç‰©</h3><input type="hidden" id="editGiftId"><div class="space-y-3"><input id="editGiftName" class="w-full border p-2"><input id="editGiftPrice" type="number" class="w-full border p-2"><input id="editGiftStock" type="number" class="w-full border p-2"><input id="editGiftImage" type="file" class="w-full text-sm"></div><div class="flex justify-end gap-3 mt-4"><button onclick="closeModal('giftModal')" class="px-4 py-2 text-gray-500">å–æ¶ˆ</button><button onclick="saveGiftEdit()" class="bg-blue-600 text-white px-4 py-2 rounded">ä¿å­˜</button></div></div></div>
<div id="codeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center z-50"><div class="bg-white p-6 rounded-lg w-96 shadow-xl"><h3 class="font-bold mb-4">ç¼–è¾‘å…‘æ¢ç </h3><input type="hidden" id="editCodeKey"><div class="space-y-3"><input id="editCodeReward" type="number" class="w-full border p-2"><input id="editCodeMax" type="number" class="w-full border p-2"><input id="editCodeUser" class="w-full border p-2"></div><div class="flex justify-end gap-3 mt-4"><button onclick="closeModal('codeModal')" class="px-4 py-2 text-gray-500">å–æ¶ˆ</button><button onclick="saveCodeEdit()" class="bg-green-600 text-white px-4 py-2 rounded">ä¿å­˜</button></div></div></div>

<script>
const API_BASE = '/api';
let currentEditUser = '';

function switchTab(t){ document.querySelectorAll('.tab-section').forEach(e=>e.classList.add('hidden')); document.getElementById(`section-${t}`).classList.remove('hidden'); document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active')); document.getElementById(`tab-btn-${t}`).classList.add('active'); const fns = {users: loadUsers, gifts: loadGifts, skins: loadSkins, codes: loadCodes, maps: loadMaps, logs: loadRedemptions, config: loadConfig, assistants: loadAssistants}; if(fns[t]) fns[t](); }
function showToast(m,t='s'){ const d=document.createElement('div'); d.className=`${t==='e'?'bg-red-500':'bg-green-500'} text-white px-4 py-2 rounded shadow mb-2`; d.innerText=m; document.getElementById('toast-container').appendChild(d); setTimeout(()=>d.remove(),3000); }
function closeModal(id){document.getElementById(id).classList.add('hidden');}

// Users, Gifts, Skins, Codes, Maps, Logs, Config functions
async function loadUsers(){ const s=document.getElementById('searchUserInput').value; const r=await fetch(`${API_BASE}/admin/users?search=${s}`); const d=await r.json(); document.getElementById('userTableBody').innerHTML=d.map(u=>`<tr class="hover:bg-gray-50 border-b"><td class="p-3 font-bold">${u.username}</td><td class="p-3 font-bold text-yellow-600">${u.coins}</td><td class="p-3 font-bold text-orange-600">${u.tickets}</td><td class="p-3 text-xs text-gray-500">${u.current_skin}</td><td class="p-3"><button onclick="openEditUser('${u.username}',${u.coins},${u.tickets})" class="text-blue-600 border px-2 py-1 rounded hover:bg-blue-50">ç¼–è¾‘</button></td></tr>`).join(''); }
function openEditUser(u,c,t){ currentEditUser=u; document.getElementById('editUserTitle').innerText=u; document.getElementById('editUserCoins').value=c; document.getElementById('editUserTickets').value=t; document.getElementById('userModal').classList.remove('hidden'); }
async function saveUserEdit(){ await fetch(`${API_BASE}/admin/update_user`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:currentEditUser,coins:parseInt(document.getElementById('editUserCoins').value),tickets:parseInt(document.getElementById('editUserTickets').value)})}); closeModal('userModal'); loadUsers(); showToast('ä¿å­˜æˆåŠŸ'); }
async function loadGifts(){ const r=await fetch(`${API_BASE}/admin/gifts`); const d=await r.json(); document.getElementById('giftTableBody').innerHTML=d.map(g=>`<tr class="border-b"><td class="p-3"><img src="${g.image_url}" class="w-10 h-10 object-cover rounded border"></td><td class="p-3 font-bold">${g.name}</td><td class="p-3 text-orange-600">${g.price}</td><td class="p-3">${g.stock}</td><td class="p-3"><button onclick="openEditGift(${g.id},'${g.name}',${g.price},${g.stock})" class="text-blue-600 border px-2 py-1 rounded hover:bg-blue-50">ä¿®æ”¹</button></td></tr>`).join(''); }
document.getElementById('addGiftForm').onsubmit=async(e)=>{ e.preventDefault(); await fetch(`${API_BASE}/admin/add_gift`,{method:'POST',body:new FormData(e.target)}); showToast('ä¸Šæ¶æˆåŠŸ'); e.target.reset(); loadGifts(); }
function openEditGift(id,n,p,s){ document.getElementById('editGiftId').value=id; document.getElementById('editGiftName').value=n; document.getElementById('editGiftPrice').value=p; document.getElementById('editGiftStock').value=s; document.getElementById('giftModal').classList.remove('hidden'); }
async function saveGiftEdit(){ const fd=new FormData(); fd.append('id',document.getElementById('editGiftId').value); fd.append('name',document.getElementById('editGiftName').value); fd.append('price',document.getElementById('editGiftPrice').value); fd.append('stock',document.getElementById('editGiftStock').value); const f=document.getElementById('editGiftImage').files[0]; if(f)fd.append('image',f); await fetch(`${API_BASE}/admin/update_gift`,{method:'POST',body:fd}); closeModal('giftModal'); loadGifts(); showToast('ä¿®æ”¹æˆåŠŸ'); }
async function loadSkins(){ const r=await fetch(`${API_BASE}/skins?all=1`); const d=await r.json(); document.getElementById('skinGrid').innerHTML=d.map(s=>`<div class="border rounded p-3 flex flex-col items-center bg-white shadow-sm"><img src="${s.image_url}" class="w-16 h-16 rounded-full border mb-2"><div class="font-bold text-sm">${s.name}</div><div class="text-xs ${s.is_active?'text-green-600':'text-red-500'} mb-2">â— ${s.is_active?'å¯ç”¨':'åœç”¨'}</div><div class="flex gap-2"><button onclick="toggleSkin(${s.id},${!s.is_active})" class="text-xs border px-2 py-1 rounded hover:bg-gray-100">${s.is_active?'åœç”¨':'å¯ç”¨'}</button><button onclick="deleteSkin(${s.id})" class="text-xs border border-red-200 text-red-600 px-2 py-1 rounded hover:bg-red-50">åˆ é™¤</button></div></div>`).join(''); }
document.getElementById('addSkinForm').onsubmit=async(e)=>{ e.preventDefault(); await fetch(`${API_BASE}/admin/add_skin`,{method:'POST',body:new FormData(e.target)}); showToast('ä¸Šä¼ æˆåŠŸ'); e.target.reset(); loadSkins(); }
async function toggleSkin(id,a){ await fetch(`${API_BASE}/admin/toggle_skin`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,is_active:a?1:0})}); loadSkins(); }
async function deleteSkin(id){ if(!confirm('åˆ é™¤?'))return; await fetch(`${API_BASE}/admin/delete_skin`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})}); loadSkins(); showToast('å·²åˆ é™¤'); }
async function loadCodes(){ const r=await fetch(`${API_BASE}/admin/codes`); const d=await r.json(); document.getElementById('codeTableBody').innerHTML=d.map(c=>`<tr class="hover:bg-gray-50 border-b"><td class="p-3 font-bold">${c.code}</td><td class="p-3 text-yellow-600">${c.reward_amount}</td><td class="p-3">${c.current_uses}/${c.max_uses}</td><td class="p-3 text-xs">${c.target_user||'All'}</td><td class="p-3"><button onclick="openEditCode('${c.code}',${c.reward_amount},${c.max_uses},'${c.target_user||''}')" class="text-green-600 border px-2 py-1 rounded hover:bg-green-50">ç¼–è¾‘</button></td></tr>`).join(''); }
async function createCode(){ await fetch(`${API_BASE}/admin/codes`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code:document.getElementById('newCodeStr').value, reward_amount:parseInt(document.getElementById('newCodeReward').value), max_uses:parseInt(document.getElementById('newCodeMax').value)})}); showToast('ç”ŸæˆæˆåŠŸ'); loadCodes(); }
function openEditCode(c,r,m,u){ document.getElementById('editCodeKey').value=c; document.getElementById('editCodeReward').value=r; document.getElementById('editCodeMax').value=m; document.getElementById('editCodeUser').value=u; document.getElementById('codeModal').classList.remove('hidden'); }
async function saveCodeEdit(){ await fetch(`${API_BASE}/admin/update_code`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code:document.getElementById('editCodeKey').value, reward_amount:parseInt(document.getElementById('editCodeReward').value), max_uses:parseInt(document.getElementById('editCodeMax').value), target_user:document.getElementById('editCodeUser').value})}); closeModal('codeModal'); loadCodes(); showToast('ä¿å­˜æˆåŠŸ'); }
async function loadMaps(){ const r=await fetch(`${API_BASE}/maps`); const d=await r.json(); document.getElementById('mapsGrid').innerHTML=d.map(m => { const isCustom = m.author && m.author !== 'System'; const bgClass = isCustom ? 'bg-green-50 border-green-200' : 'bg-blue-50 border-blue-200'; const typeBadge = isCustom ? `<span class="text-xs bg-green-200 text-green-800 px-1 rounded">ç©å®¶è‡ªåˆ¶ (${m.author})</span>` : `<span class="text-xs bg-blue-200 text-blue-800 px-1 rounded">å®˜æ–¹</span>`; return `<div class="border p-3 rounded flex flex-col gap-2 ${bgClass} shadow-sm relative group"><div class="flex justify-between items-start"><div class="truncate pr-2"><div class="font-bold text-sm" title="${m.name}">${m.name}</div><div class="mt-1">${typeBadge}</div></div><button onclick="toggleMap('${m.key}',${!m.is_active})" class="text-xs font-bold ${m.is_active?'text-green-600':'text-red-500'} border px-2 py-1 rounded bg-white">${m.is_active ? 'å¯ç”¨ä¸­' : 'å·²åœç”¨'}</button></div><div class="flex items-center gap-2 mt-2 bg-white p-2 rounded border border-gray-100"><span class="text-xs text-gray-500 font-bold">æƒé‡:</span><input type="number" min="0" value="${m.weight !== undefined ? m.weight : 10}" onchange="updateMapWeight('${m.key}', this.value)" class="border rounded w-16 px-1 text-xs text-center focus:ring-2 focus:ring-indigo-200 outline-none"><div class="text-xs text-gray-400">æ¦‚ç‡</div></div>${isCustom ? `<button onclick="deleteMap('${m.key}')" class="absolute -top-2 -right-2 bg-red-500 text-white w-6 h-6 rounded-full opacity-0 group-hover:opacity-100 transition shadow hover:bg-red-600 flex items-center justify-center text-xs" title="åˆ é™¤åœ°å›¾">Ã—</button>` : ''}</div>`}).join(''); }
async function toggleMap(k,a){ await fetch(`${API_BASE}/admin/toggle_map`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({key:k,active:a})}); loadMaps(); }
async function updateMapWeight(k,w){ await fetch(`${API_BASE}/admin/update_map_weight`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({key:k, weight:parseInt(w)})}); showToast('æƒé‡å·²æ›´æ–°', 's'); }
async function deleteMap(k) { if(!confirm("ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™å¼ åœ°å›¾å—ï¼Ÿ")) return; const r = await fetch(`${API_BASE}/admin/delete_map`, {method: 'POST',headers: {'Content-Type': 'application/json'},body: JSON.stringify({key: k})}); const d = await r.json(); if(d.success) { showToast('å·²åˆ é™¤'); loadMaps(); } else { showToast(d.message, 'e'); } }
async function loadRedemptions(){ const r=await fetch(`${API_BASE}/admin/redemptions`); const d=await r.json(); document.getElementById('logTableBody').innerHTML=d.map(l=>`<tr class="border-b"><td class="p-3 text-xs">${l.redeem_time}</td><td class="p-3 font-bold">${l.user_id}</td><td class="p-3">${l.gift_name}</td><td class="p-3 text-red-500">-${l.cost}</td><td class="p-3 text-xs">${l.status}</td></tr>`).join(''); }
async function loadConfig(){ const r=await fetch(`${API_BASE}/config`); const c=await r.json(); if(!c.slot_count)return; document.getElementById('cfg_slot_count').value = c.slot_count; for(let i=1;i<=5;i++){ document.getElementById(`cfg_light_${i}`).value=c.light_rules[i]; document.getElementById(`cfg_mult_${i}`).value=c.multiplier_rules[i]; } document.getElementById('cfg_wheel_enabled').checked=c.lucky_wheel.enabled; document.getElementById('cfg_wheel_prob').value=c.lucky_wheel.prob; document.getElementById('cfg_wheel_min').value=c.lucky_wheel.min; document.getElementById('cfg_wheel_max').value=c.lucky_wheel.max; document.getElementById('cfg_bomb_prob').value=c.bomb_config.prob; document.getElementById('cfg_bomb_min').value=c.bomb_config.count_min; document.getElementById('cfg_bomb_max').value=c.bomb_config.count_max; document.getElementById('cfg_temp_prob').value=c.coin_config.temp_prob; document.getElementById('cfg_temp_min').value=c.coin_config.temp_min; document.getElementById('cfg_temp_max').value=c.coin_config.temp_max; document.getElementById('cfg_temp_val').value=c.coin_config.temp_val; document.getElementById('cfg_fixed_prob').value=c.coin_config.fixed_prob; document.getElementById('cfg_fixed_min').value=c.coin_config.fixed_min; document.getElementById('cfg_fixed_max').value=c.coin_config.fixed_max; document.getElementById('cfg_fixed_val').value=c.coin_config.fixed_val; document.getElementById('cfg_exchange_rate').value=c.exchange_rate || 0.1; if(c.egg_config) { document.getElementById('cfg_egg_appear_prob').value = c.egg_config.appear_prob || 0.2; document.getElementById('cfg_egg_count_min').value = c.egg_config.count_min || 1; document.getElementById('cfg_egg_count_max').value = c.egg_config.count_max || 1; document.getElementById('cfg_egg_prob_coin').value = c.egg_config.probs.coin; document.getElementById('cfg_egg_prob_ticket').value = c.egg_config.probs.ticket; document.getElementById('cfg_egg_prob_mouse').value = c.egg_config.probs.mouse; document.getElementById('cfg_egg_reward_coin').value = c.egg_config.rewards.coin; document.getElementById('cfg_egg_reward_ticket').value = c.egg_config.rewards.ticket; document.getElementById('cfg_egg_penalty_coin').value = c.egg_config.penalties.coin; document.getElementById('cfg_egg_penalty_ticket').value = c.egg_config.penalties.ticket; } document.getElementById('cfg_ai_voice_enabled').checked = c.ai_voice_enabled === 'true' || c.ai_voice_enabled === true; document.getElementById('cfg_openai_endpoint').value = c.openai_api_endpoint || ''; document.getElementById('cfg_openai_key').value = c.openai_api_key || ''; document.getElementById('cfg_ai_max_tokens').value = c.ai_max_tokens || 60; document.getElementById('cfg_tts_mode').value = c.tts_mode || 'server'; document.getElementById('cfg_tts_endpoint').value = c.tts_api_endpoint || ''; document.getElementById('cfg_tts_voice').value = c.tts_voice_name || ''; document.getElementById('cfg_tts_local_path').value = c.tts_audio_local_path || ''; }
document.getElementById('gameConfigForm').onsubmit=async(e)=>{ e.preventDefault(); const cfg = { slot_count: document.getElementById('cfg_slot_count').value, light_rules:{}, multiplier_rules:{}, lucky_wheel: { enabled:document.getElementById('cfg_wheel_enabled').checked, prob:parseFloat(document.getElementById('cfg_wheel_prob').value), min:parseInt(document.getElementById('cfg_wheel_min').value), max:parseInt(document.getElementById('cfg_wheel_max').value) }, bomb_config: { prob:parseFloat(document.getElementById('cfg_bomb_prob').value), count_min:parseInt(document.getElementById('cfg_bomb_min').value), count_max:parseInt(document.getElementById('cfg_bomb_max').value) }, coin_config: { temp_prob:parseFloat(document.getElementById('cfg_temp_prob').value), temp_min:parseInt(document.getElementById('cfg_temp_min').value), temp_max:parseInt(document.getElementById('cfg_temp_max').value), temp_val:parseInt(document.getElementById('cfg_temp_val').value), fixed_prob:parseFloat(document.getElementById('cfg_fixed_prob').value), fixed_min:parseInt(document.getElementById('cfg_fixed_min').value), fixed_max:parseInt(document.getElementById('cfg_fixed_max').value), fixed_val:parseInt(document.getElementById('cfg_fixed_val').value) }, egg_config: { appear_prob: parseFloat(document.getElementById('cfg_egg_appear_prob').value), count_min: parseInt(document.getElementById('cfg_egg_count_min').value), count_max: parseInt(document.getElementById('cfg_egg_count_max').value), probs: { coin: parseFloat(document.getElementById('cfg_egg_prob_coin').value), ticket: parseFloat(document.getElementById('cfg_egg_prob_ticket').value), mouse: parseFloat(document.getElementById('cfg_egg_prob_mouse').value) }, rewards: { coin: parseInt(document.getElementById('cfg_egg_reward_coin').value), ticket: parseInt(document.getElementById('cfg_egg_reward_ticket').value) }, penalties: { coin: parseInt(document.getElementById('cfg_egg_penalty_coin').value), ticket: parseInt(document.getElementById('cfg_egg_penalty_ticket').value) } }, exchange_rate: parseFloat(document.getElementById('cfg_exchange_rate').value), ai_voice_enabled: document.getElementById('cfg_ai_voice_enabled').checked, openai_api_endpoint: document.getElementById('cfg_openai_endpoint').value, openai_api_key: document.getElementById('cfg_openai_key').value, ai_max_tokens: parseInt(document.getElementById('cfg_ai_max_tokens').value), tts_mode: document.getElementById('cfg_tts_mode').value, tts_api_endpoint: document.getElementById('cfg_tts_endpoint').value, tts_voice_name: document.getElementById('cfg_tts_voice').value, tts_audio_local_path: document.getElementById('cfg_tts_local_path').value, }; for(let i=1;i<=5;i++){ cfg.light_rules[i]=parseInt(document.getElementById(`cfg_light_${i}`).value); cfg.multiplier_rules[i]=parseInt(document.getElementById(`cfg_mult_${i}`).value); } await fetch(`${API_BASE}/admin/update_config`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(cfg)}); showToast('é…ç½®å·²æ›´æ–°'); };

// --- AI Assistants ---
async function loadAssistants() { const r = await fetch(`${API_BASE}/admin/assistants`); const assistants = await r.json(); const listEl = document.getElementById('assistants-list'); listEl.innerHTML = assistants.map(a => `<div class="border p-3 rounded-lg flex justify-between items-center bg-white shadow-sm"><div><div class="font-bold">${a.name} <span class="text-xs font-normal ${a.is_active ? 'text-green-600' : 'text-red-500'}">â— ${a.is_active ? 'å·²å¯ç”¨' : 'å·²åœç”¨'}</span></div><div class="text-xs text-gray-500 mt-1">ID: ${a.id} | Model: ${a.model || 'N/A'}</div></div><div class="flex gap-2"><button onclick="editAssistant('${a.id}', '${a.name}', '${a.openai_api_key || ''}', '${a.model || ''}', \`${a.system_prompt || ''}\`, ${a.is_active})" class="text-blue-600 border px-3 py-1 rounded text-sm hover:bg-blue-50">ç¼–è¾‘</button><button onclick="deleteAssistant('${a.id}')" class="text-red-600 border px-3 py-1 rounded text-sm hover:bg-red-50">åˆ é™¤</button></div></div>`).join(''); }
function resetAssistantForm() { document.getElementById('assistantForm').reset(); document.getElementById('asst-id').value = ''; document.getElementById('assistant-form-title').innerText = 'â• æ–°å»ºAIåŠ©æ‰‹'; }
function editAssistant(id, name, key, model, prompt, active) { document.getElementById('asst-id').value = id; document.getElementById('asst-name').value = name; document.getElementById('asst-key').value = key; document.getElementById('asst-model').value = model; document.getElementById('asst-prompt').value = prompt; document.getElementById('asst-active').checked = active; document.getElementById('assistant-form-title').innerText = 'âœï¸ ç¼–è¾‘AIåŠ©æ‰‹'; window.scrollTo(0, 0); }
document.getElementById('assistantForm').onsubmit = async (e) => { e.preventDefault(); const id = document.getElementById('asst-id').value; const payload = { name: document.getElementById('asst-name').value, openai_api_key: document.getElementById('asst-key').value, model: document.getElementById('asst-model').value, system_prompt: document.getElementById('asst-prompt').value, is_active: document.getElementById('asst-active').checked, }; const url = id ? `${API_BASE}/admin/assistants/update` : `${API_BASE}/admin/assistants`; if (id) payload.id = id; const r = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) }); const d = await r.json(); if (d.success) { showToast('ä¿å­˜æˆåŠŸ'); resetAssistantForm(); loadAssistants(); } else { showToast(d.message || 'ä¿å­˜å¤±è´¥', 'e'); } };
async function deleteAssistant(id) { if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåŠ©æ‰‹å—ï¼Ÿ')) return; const r = await fetch(`${API_BASE}/admin/assistants/delete`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({id}) }); const d = await r.json(); if (d.success) { showToast('åˆ é™¤æˆåŠŸ'); loadAssistants(); } else { showToast(d.message || 'åˆ é™¤å¤±è´¥', 'e'); } }

// Init
switchTab('users');
</script>
</body>
</html>