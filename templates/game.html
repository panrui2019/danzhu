<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Amyä¸ƒå½©å¼¹ç ä¹å›­</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zcool+KuaiLe&display=swap');
        /* ... existing styles ... */
        #side-panel select { font-size: 13px; padding: 6px 8px; }
    </style>
</head>
<body>
    <!-- ... existing html ... -->
    <div id="side-panel">
        <div id="rules-panel">
            <h3 class="text-center text-lg text-purple-700 font-bold border-b-2 border-purple-200 pb-2 mb-2">ç©å®¶ä¿¡æ¯</h3>
            <div class="flex justify-between items-center mb-2">
                <span>ç”¨æˆ·: <span id="user-display" class="font-bold text-purple-700">æœªç™»å½•</span></span>
                <button onclick="manualSync()" class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded border border-indigo-300 hover:bg-indigo-200" title="ä»æœåŠ¡å™¨åŒæ­¥æœ€æ–°æ•°æ®">ğŸ”„ åŒæ­¥</button>
            </div>
            <div class="mb-2 text-xs text-gray-500">ç‚¹å‡»åŒæ­¥æŒ‰é’®è·å–æœ€æ–°ä½™é¢</div>
            <div class="mt-2">
                <label for="ai-assistant-select" class="text-xs font-bold text-purple-800">é€‰æ‹©AIåŠ©æ‰‹:</label>
                <select id="ai-assistant-select" class="w-full border border-gray-300 rounded px-2 py-1 mt-1 text-sm"></select>
            </div>
        </div>
        <div id="card-box"><div id="stack-inner"></div></div><div id="card-counter-panel"><div style="font-size:12px; color:#ccc;">å½“å‰ç§¯åˆ†</div><div id="total-tickets">0</div></div>
        <div id="control-panel">
            <!-- ... existing controls ... -->
        </div>
    </div>
    <!-- ... rest of the html ... -->

<script>
// ... existing script ...

let selectedAssistantId = null;

// --- AI Voice ---
async function playAiVoice(gameData) {
    if (!currentUser || !gameConfig.ai_voice_enabled) return;

    const logKey = `log_${currentUser}`;
    const allLogs = JSON.parse(localStorage.getItem(logKey) || '[]').slice(0, 100);
    const lastGameStartIndex = allLogs.findIndex(log => log.message === 'æŠ•å¸ -1 é‡‘å¸');
    const currentGameHistory = lastGameStartIndex !== -1 ? allLogs.slice(0, lastGameStartIndex + 1) : allLogs.slice(0, 10);
    const fullHistory = allLogs.slice(0, 30);

    const payload = {
        ...gameData,
        history: JSON.stringify(currentGameHistory),
        full_history: JSON.stringify(fullHistory),
        assistant_id: selectedAssistantId
    };

    // ... rest of the playAiVoice function is the same
}

async function fetchAssistants() {
    try {
        const r = await fetch(`${API_URL}/assistants`);
        const assistants = await r.json();
        const selectEl = document.getElementById('ai-assistant-select');
        selectEl.innerHTML = '<option value="">é»˜è®¤åŠ©æ‰‹</option>' + assistants.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
        selectEl.onchange = () => {
            selectedAssistantId = selectEl.value || null;
        };
    } catch (e) {
        console.error("Failed to fetch assistants", e);
    }
}

function initSession(u){
    // ... existing initSession code ...
    fetchAssistants(); // Fetch assistants on login
}

// ... rest of the script ...
</script>
</body>
</html>